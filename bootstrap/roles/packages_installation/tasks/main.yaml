- block:
  - name: Ensure base packages are installed (Debian)
    ansible.builtin.apt:
      update-cache: true
      name: "{{ packages_list_installed }}"
      state: present
    tags:
      - package
    when:
      - ansible_os_family == "Debian"
      - packages_list_installed | length > 0

  - block:
      - name: Install packages (RedHat)
        ansible.builtin.dnf:
          update-cache: true
          name: "{{ packages_list_installed }}"
          state: present
        when:
          - ansible_os_family == "RedHat"
          - packages_list_installed | length > 0

    rescue:
      - name: Ensure EPEL repo is installed
        ansible.builtin.dnf:
          name: epel-release
          state: present
        when:
          - ansible_os_family == "RedHat"
          - packages_list_installed | length > 0
      - name: Retry package installation (RedHat)
        ansible.builtin.dnf:
          name: "{{ packages_list_installed }}"
          state: present
        when:
          - ansible_os_family == "RedHat"
          - packages_list_installed | length > 0
  when:
    - packages_list_installed is defined
    - packages_list_installed is not none
